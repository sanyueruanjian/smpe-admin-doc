<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>权限控制 | SMPE官方文档</title>
    <meta name="generator" content="VuePress 1.8.0">
    <link rel="icon" href="/smpe-admin-doc/logo.png">
    <meta name="description" content="SMPE开发文档">
    
    <link rel="preload" href="/smpe-admin-doc/assets/css/0.styles.6a5a8a3c.css" as="style"><link rel="preload" href="/smpe-admin-doc/assets/js/app.f4ff953f.js" as="script"><link rel="preload" href="/smpe-admin-doc/assets/js/2.edc9681b.js" as="script"><link rel="preload" href="/smpe-admin-doc/assets/js/10.f5e8e399.js" as="script"><link rel="prefetch" href="/smpe-admin-doc/assets/js/11.c236d34c.js"><link rel="prefetch" href="/smpe-admin-doc/assets/js/12.626a60e7.js"><link rel="prefetch" href="/smpe-admin-doc/assets/js/13.2c1afcce.js"><link rel="prefetch" href="/smpe-admin-doc/assets/js/14.5fee5ea6.js"><link rel="prefetch" href="/smpe-admin-doc/assets/js/15.b0975fff.js"><link rel="prefetch" href="/smpe-admin-doc/assets/js/16.b13ce075.js"><link rel="prefetch" href="/smpe-admin-doc/assets/js/17.e8f66a54.js"><link rel="prefetch" href="/smpe-admin-doc/assets/js/3.fb482fec.js"><link rel="prefetch" href="/smpe-admin-doc/assets/js/4.c0299c15.js"><link rel="prefetch" href="/smpe-admin-doc/assets/js/5.160cab52.js"><link rel="prefetch" href="/smpe-admin-doc/assets/js/6.504f3820.js"><link rel="prefetch" href="/smpe-admin-doc/assets/js/7.6d0b9443.js"><link rel="prefetch" href="/smpe-admin-doc/assets/js/8.1fc4a2f9.js"><link rel="prefetch" href="/smpe-admin-doc/assets/js/9.615a8893.js">
    <link rel="stylesheet" href="/smpe-admin-doc/assets/css/0.styles.6a5a8a3c.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/smpe-admin-doc/" class="home-link router-link-active"><!----> <span class="site-name">SMPE官方文档</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/smpe-admin-doc/guide/" class="nav-link router-link-active">
  项目指南
</a></div><div class="nav-item"><a href="/smpe-admin-doc/question/" class="nav-link">
  常见问题
</a></div><div class="nav-item"><a href="/smpe-admin-doc/note/" class="nav-link">
  更新日志
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="GitHub" class="dropdown-title"><span class="title">GitHub</span> <span class="arrow down"></span></button> <button type="button" aria-label="GitHub" class="mobile-dropdown-title"><span class="title">GitHub</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>
          地址
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="https://github.com/sanyueruanjian/smpe-admin" target="_blank" rel="noopener noreferrer" class="nav-link external">
  后端源码
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-subitem"><a href="https://github.com/sanyueruanjian/smpe-admin-web" target="_blank" rel="noopener noreferrer" class="nav-link external">
  前端源码
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/smpe-admin-doc/guide/" class="nav-link router-link-active">
  项目指南
</a></div><div class="nav-item"><a href="/smpe-admin-doc/question/" class="nav-link">
  常见问题
</a></div><div class="nav-item"><a href="/smpe-admin-doc/note/" class="nav-link">
  更新日志
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="GitHub" class="dropdown-title"><span class="title">GitHub</span> <span class="arrow down"></span></button> <button type="button" aria-label="GitHub" class="mobile-dropdown-title"><span class="title">GitHub</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>
          地址
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="https://github.com/sanyueruanjian/smpe-admin" target="_blank" rel="noopener noreferrer" class="nav-link external">
  后端源码
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-subitem"><a href="https://github.com/sanyueruanjian/smpe-admin-web" target="_blank" rel="noopener noreferrer" class="nav-link external">
  前端源码
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>指南</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/smpe-admin-doc/guide/" aria-current="page" class="sidebar-link">项目介绍</a></li><li><a href="/smpe-admin-doc/guide/fastKnow.html" class="sidebar-link">快速了解</a></li><li><a href="/smpe-admin-doc/guide/fastStart.html" class="sidebar-link">快速开始</a></li><li><a href="/smpe-admin-doc/guide/frontHandbook.html" class="sidebar-link">前端手册</a></li><li><a href="/smpe-admin-doc/guide/behindHandbook.html" aria-current="page" class="active sidebar-link">后端手册</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/smpe-admin-doc/guide/behindHandbook.html#权限控制" class="sidebar-link">权限控制</a></li><li class="sidebar-sub-header"><a href="/smpe-admin-doc/guide/behindHandbook.html#系统缓存" class="sidebar-link">系统缓存</a></li><li class="sidebar-sub-header"><a href="/smpe-admin-doc/guide/behindHandbook.html#异常处理" class="sidebar-link">异常处理</a></li><li class="sidebar-sub-header"><a href="/smpe-admin-doc/guide/behindHandbook.html#数据权限" class="sidebar-link">数据权限</a></li><li class="sidebar-sub-header"><a href="/smpe-admin-doc/guide/behindHandbook.html#定时任务" class="sidebar-link">定时任务</a></li><li class="sidebar-sub-header"><a href="/smpe-admin-doc/guide/behindHandbook.html#异步线程池" class="sidebar-link">异步线程池</a></li><li class="sidebar-sub-header"><a href="/smpe-admin-doc/guide/behindHandbook.html#线程池工具" class="sidebar-link">线程池工具</a></li><li class="sidebar-sub-header"><a href="/smpe-admin-doc/guide/behindHandbook.html#分页实现" class="sidebar-link">分页实现</a></li><li class="sidebar-sub-header"><a href="/smpe-admin-doc/guide/behindHandbook.html#自定义后端代码生成" class="sidebar-link">自定义后端代码生成</a></li><li class="sidebar-sub-header"><a href="/smpe-admin-doc/guide/behindHandbook.html#自定义扩展mybatis-plus" class="sidebar-link">自定义扩展MyBatis-Plus</a></li></ul></li><li><a href="/smpe-admin-doc/guide/deployProject.html" class="sidebar-link">部署项目</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>鸣谢</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/smpe-admin-doc/guide/thanks.html" class="sidebar-link">特别鸣谢</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h2 id="权限控制"><a href="#权限控制" class="header-anchor">#</a> 权限控制</h2> <p>本系统权限控制采用 <code>RBAC</code>思想。简单地说，一个用户拥有若干角色，每一个角色拥有若干个菜单，菜单中存在菜单权限与按钮权限， 这样，就构造成“用户-角色-菜单” 的授权模型。在这种模型中，用户与角色、角色与菜单之间构成了多对多的关系，如下图</p> <img src="/smpe-admin-doc/img/image17.png" alt="foo"> <p>本系统安全框架使用的是 <code>Spring Security + Jwt Token</code>， 访问后端接口需在请求头中携带 <code>token</code>进行访问</p> <h3 id="数据交互"><a href="#数据交互" class="header-anchor">#</a> <strong>数据交互</strong></h3> <p>用户登录 -&gt; 后端验证登录返回 <code>token</code>-&gt; 前端带上<code>token</code>请求后端数据 -&gt; 后端返回数据， 数据交互流程如下：</p> <img src="/smpe-admin-doc/img/image28.jpg" alt="foo"> <h3 id="权限方法及注解"><a href="#权限方法及注解" class="header-anchor">#</a> <strong>权限方法及注解</strong></h3> <p>在<code>SpringSecurity</code>安全框架中，提供了一些方法和注解来帮助我们进行权限判断和数据过滤</p> <table><thead><tr><th><strong>表达式</strong></th> <th><strong>描述</strong></th></tr></thead> <tbody><tr><td>hasRole(String role)</td> <td>当前用户是否拥有指定角色。如果用户具备给定角色就则返回true，否则出现403</td></tr> <tr><td>hasAnyRole(String... roles)</td> <td>多个角色是一个以逗号进行分隔的字符串。如果当前用户拥有指定角色中的任意一个则返回true。</td></tr> <tr><td>hasAuthority(String authority)</td> <td>如果当前的主体具有指定的权限，则返回 true,否则返回 false  。适用于单个角色，不适用于多个角色权限</td></tr> <tr><td>hasAnyAuthority(String... authorities)</td> <td>如果当前的主体有任何提供的角色（给定的作为一个逗号分隔的字符串列表）的话，返回 true。适用于多个角色权限</td></tr> <tr><td>@Secured</td> <td>判断是否具有角色，另外需要注意这里匹配的字符串需要加前缀&quot;ROLE_&quot;</td></tr> <tr><td>@PreAuthorize</td> <td>注解适合进入方法前的权限验证，可以将登录用户的roles/permissions参数传到方法中。方法执行之前校验</td></tr> <tr><td>@PostAuthorize</td> <td>使用并不多，在方法执行后再进行权限验证，适合验证带有返回值的权限</td></tr> <tr><td>@PostFilter</td> <td>对返回的数据进行过滤</td></tr> <tr><td>@PreFilter</td> <td>对传入的数据进行过滤</td></tr></tbody></table> <p>下面的接口表示用户拥有<code>user:del</code>权限就能能访问<code>delete</code>方法， 如果方法不加<code>@preAuthorize</code>注解，意味着所有用户都需要带上有效的<code>token</code> 后才能访问<code>delete</code></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code> <span class="token annotation punctuation">@ApiOperation</span><span class="token punctuation">(</span><span class="token string">&quot;删除用户&quot;</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@DeleteMapping</span>
    <span class="token annotation punctuation">@PreAuthorize</span><span class="token punctuation">(</span><span class="token string">&quot;@smpe.check('user:del')&quot;</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@Transactional</span><span class="token punctuation">(</span>rollbackFor <span class="token operator">=</span> <span class="token class-name">Exception</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">Result</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">&gt;</span></span> <span class="token function">delete</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestBody</span> <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> ids<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Long</span> id <span class="token operator">:</span> ids<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">checkLevel</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;【删除用户失败】角色权限不足，不能删除。&quot;</span> <span class="token operator">+</span> <span class="token string">&quot;操作人id：&quot;</span> <span class="token operator">+</span> <span class="token class-name">SecurityUtils</span><span class="token punctuation">.</span><span class="token function">getCurrentUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;。预删除用户id：&quot;</span> <span class="token operator">+</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BadRequestException</span><span class="token punctuation">(</span><span class="token string">&quot;角色权限不足，不能删除：&quot;</span> <span class="token operator">+</span> userService<span class="token punctuation">.</span><span class="token function">getById</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getUsername</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">boolean</span> isDel <span class="token operator">=</span> userService<span class="token punctuation">.</span><span class="token function">removeByIds</span><span class="token punctuation">(</span>ids<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span> isDel<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;【删除用户失败】角色权限不足，不能删除。&quot;</span> <span class="token operator">+</span> <span class="token string">&quot;操作人id：&quot;</span> <span class="token operator">+</span> <span class="token class-name">SecurityUtils</span><span class="token punctuation">.</span><span class="token function">getCurrentUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;。预删除用户id集合：&quot;</span> <span class="token operator">+</span> ids<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BadRequestException</span><span class="token punctuation">(</span><span class="token string">&quot;【删除用户失败】&quot;</span> <span class="token operator">+</span> <span class="token string">&quot;操作人id：&quot;</span> <span class="token operator">+</span> <span class="token class-name">SecurityUtils</span><span class="token punctuation">.</span><span class="token function">getCurrentUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p><code>check()</code> 方法表示如果该身份是admin的话，直接返回true，不再进行多余判断。如果不是admin的话，将用户的所有身份进行判断，看是否有匹配的身份，若有返会true，无则返回false</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Service</span><span class="token punctuation">(</span>value<span class="token operator">=</span><span class="token string">&quot;smpe&quot;</span><span class="token punctuation">)</span>
publicclassPermissionConfig <span class="token punctuation">{</span>
<span class="token function">publicBooleancheck</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> permissions<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token comment">// 获取当前用户的所有权限</span>
<span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span>smpePermissions<span class="token operator">=</span>
<span class="token class-name">SecurityUtils</span><span class="token punctuation">.</span><span class="token function">getCurrentUser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAuthorities</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token class-name">GrantedAuthority</span><span class="token operator">::</span><span class="token function">getAuthority</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 判断当前用户的所有权限是否包含接口上定义的权限</span>
returnsmpePermissions<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span><span class="token string">&quot;admin&quot;</span><span class="token punctuation">)</span> <span class="token operator">||</span><span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span>permissions<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">anyMatch</span><span class="token punctuation">(</span>smpePermissions<span class="token operator">::</span><span class="token function">contains</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>使用方式：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@PreAuthorize</span><span class="token punctuation">(</span><span class="token string">&quot;@smpe.check('user:del')&quot;</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h3 id="接口放行"><a href="#接口放行" class="header-anchor">#</a> <strong>接口放行</strong></h3> <p>在我们使用的时候，有些接口是不需要验证权限的，这个时候就需要我们给接口放行，使用方式如下：</p> <p>1、使用注解方式</p> <p>只需要在<code>Controller</code>的方法上加入该注解即可<code>@AnonymousAccess</code></p> <p>2、修改配置文件方式</p> <p>smpe-system -&gt; modules -&gt; security -&gt; config -&gt; SecurityConfig</p> <p>使用 <code>permitAll()</code>方法所有人都能访问，包括带上 <code>token</code>访问使用 <code>anonymous()</code>所有人都能访问，但是带上 <code>token</code>访问后会报错</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// 关键代码，部分略</span>
<span class="token function">protectedvoidconfigure</span><span class="token punctuation">(</span><span class="token class-name">HttpSecurityhttpSecurity</span><span class="token punctuation">)</span> throwsException <span class="token punctuation">{</span>
<span class="token comment">// 搜寻匿名标记 url： @AnonymousAccess</span>
<span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">RequestMappingInfo</span><span class="token punctuation">,</span> <span class="token class-name">HandlerMethod</span><span class="token punctuation">&gt;</span></span>handlerMethodMap<span class="token operator">=</span>
applicationContext<span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span><span class="token class-name">RequestMappingHandlerMapping</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getHandlerMethods</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 获取匿名标记</span>
<span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Set</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span>anonymousUrls<span class="token operator">=</span><span class="token function">getAnonymousUrl</span><span class="token punctuation">(</span>handlerMethodMap<span class="token punctuation">)</span><span class="token punctuation">;</span>
log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;放行的接口(匿名访问)&quot;</span><span class="token operator">+</span>anonymousUrls<span class="token punctuation">)</span><span class="token punctuation">;</span>
httpSecurity
<span class="token comment">// 自定义匿名访问所有url放行：允许匿名和带Token访问，细腻化到每个 Request 类型</span>
        <span class="token comment">// 放行OPTIONS请求</span>
                <span class="token punctuation">.</span><span class="token function">antMatchers</span><span class="token punctuation">(</span><span class="token class-name">HttpMethod</span><span class="token punctuation">.</span>OPTIONS<span class="token punctuation">,</span> <span class="token string">&quot;/**&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">permitAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">// GET</span>
                <span class="token punctuation">.</span><span class="token function">antMatchers</span><span class="token punctuation">(</span><span class="token class-name">HttpMethod</span><span class="token punctuation">.</span>GET<span class="token punctuation">,</span>
anonymousUrls<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">RequestMethodEnum</span><span class="token punctuation">.</span>GET<span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toArray</span><span class="token punctuation">(</span>newString<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">permitAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">// POST</span>
                <span class="token punctuation">.</span><span class="token function">antMatchers</span><span class="token punctuation">(</span><span class="token class-name">HttpMethod</span><span class="token punctuation">.</span>POST<span class="token punctuation">,</span>
anonymousUrls<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">RequestMethodEnum</span><span class="token punctuation">.</span>POST<span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toArray</span><span class="token punctuation">(</span>newString<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">permitAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">// PUT</span>
                <span class="token punctuation">.</span><span class="token function">antMatchers</span><span class="token punctuation">(</span><span class="token class-name">HttpMethod</span><span class="token punctuation">.</span>PUT<span class="token punctuation">,</span>
anonymousUrls<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">RequestMethodEnum</span><span class="token punctuation">.</span>PUT<span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toArray</span><span class="token punctuation">(</span>newString<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">permitAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">// PATCH</span>
                <span class="token punctuation">.</span><span class="token function">antMatchers</span><span class="token punctuation">(</span><span class="token class-name">HttpMethod</span><span class="token punctuation">.</span>PATCH<span class="token punctuation">,</span>
anonymousUrls<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">RequestMethodEnum</span><span class="token punctuation">.</span>PATCH<span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toArray</span><span class="token punctuation">(</span>newString<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">permitAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">// DELETE</span>
                <span class="token punctuation">.</span><span class="token function">antMatchers</span><span class="token punctuation">(</span><span class="token class-name">HttpMethod</span><span class="token punctuation">.</span>DELETE<span class="token punctuation">,</span>
anonymousUrls<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">RequestMethodEnum</span><span class="token punctuation">.</span>DELETE<span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toArray</span><span class="token punctuation">(</span>newString<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">permitAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">// 所有类型的接口都放行</span>
                <span class="token punctuation">.</span><span class="token function">antMatchers</span><span class="token punctuation">(</span>anonymousUrls<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token class-name">RequestMethodEnum</span><span class="token punctuation">.</span>ALL<span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toArray</span><span class="token punctuation">(</span>newString<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">permitAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">// 所有请求都需要认证</span>
                <span class="token punctuation">.</span><span class="token function">anyRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">authenticated</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token function">securityConfigurerAdapter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br></div></div><h3 id="越权处理"><a href="#越权处理" class="header-anchor">#</a> <strong>越权处理</strong></h3> <p>下面的<code>if (! checkLevel(id))</code>判断条件表示如果当前用户的权限级别 &gt; 被删除的用户权限级别，则向下执行，若当前用户的权限级别 &lt;= 被删除的用户，则抛出异常。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@ApiOperation</span><span class="token punctuation">(</span><span class="token string">&quot;删除用户&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@DeleteMapping</span>
<span class="token annotation punctuation">@PreAuthorize</span><span class="token punctuation">(</span><span class="token string">&quot;@smpe.check('user:del')&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Transactional</span><span class="token punctuation">(</span>rollbackFor<span class="token operator">=</span><span class="token class-name">Exception</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
publicResult<span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">&gt;</span></span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestBodySet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span>ids<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Longid</span> <span class="token operator">:</span> ids<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">checkLevel</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 通过checkLevel()方法判断当前用户是否越权，并返回对应的信息。</span>
log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;【删除用户失败】角色权限不足，不能删除。&quot;</span><span class="token operator">+</span><span class="token string">&quot;操作人id：&quot;</span><span class="token operator">+</span><span class="token class-name">SecurityUtils</span><span class="token punctuation">.</span><span class="token function">getCurrentUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span><span class="token string">&quot;。预删除用户id：&quot;</span><span class="token operator">+</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">thrownewBadRequestException</span><span class="token punctuation">(</span><span class="token string">&quot;角色权限不足，不能删除：&quot;</span><span class="token operator">+</span>userService<span class="token punctuation">.</span><span class="token function">getById</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getUsername</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
booleanisDel<span class="token operator">=</span>userService<span class="token punctuation">.</span><span class="token function">removeByIds</span><span class="token punctuation">(</span>ids<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isDel<span class="token punctuation">)</span> <span class="token punctuation">{</span>
log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;【删除用户失败】角色权限不足，不能删除。&quot;</span><span class="token operator">+</span><span class="token string">&quot;操作人id：&quot;</span><span class="token operator">+</span><span class="token class-name">SecurityUtils</span><span class="token punctuation">.</span><span class="token function">getCurrentUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span><span class="token string">&quot;。预删除用户id集合：&quot;</span><span class="token operator">+</span>ids<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">thrownewBadRequestException</span><span class="token punctuation">(</span><span class="token string">&quot;【删除用户失败】&quot;</span><span class="token operator">+</span><span class="token string">&quot;操作人id：&quot;</span><span class="token operator">+</span><span class="token class-name">SecurityUtils</span><span class="token punctuation">.</span><span class="token function">getCurrentUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
returnResult<span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>源码</p> <p>通过<code>checkLevel()</code>方法处理越权行为</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">/**
* description:操作多个角色时，判断用户权限（通过role的level）
* @param roleIds 预操作角色的id集合
* @return true 有权限
*/</span>
<span class="token function">privatebooleancheckLevel</span><span class="token punctuation">(</span><span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span>roleIds<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token class-name">IntegercurrentLevel</span><span class="token operator">=</span><span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>roleService<span class="token punctuation">.</span><span class="token function">findRoleByUserId</span><span class="token punctuation">(</span><span class="token class-name">SecurityUtils</span>
                <span class="token punctuation">.</span><span class="token function">getCurrentUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token class-name">RoleSmallDTO</span><span class="token operator">::</span><span class="token function">getLevel</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">IntegeroptLevel</span><span class="token operator">=</span>roleService<span class="token punctuation">.</span><span class="token function">findRoleMinLeave</span><span class="token punctuation">(</span>roleIds<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//level 越小权限越大</span>
returncurrentLevel<span class="token operator">&lt;=</span>optLevel<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token comment">/**
* description:操作用户时，判断用户权限
* @param userId 预操作用户id
* @return true 有权限
*/</span>
<span class="token function">privatebooleancheckLevel</span><span class="token punctuation">(</span><span class="token class-name">LonguserId</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token class-name">IntegercurrentLevel</span><span class="token operator">=</span>
<span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>roleService<span class="token punctuation">.</span><span class="token function">findRoleByUserId</span><span class="token punctuation">(</span><span class="token class-name">SecurityUtils</span><span class="token punctuation">.</span><span class="token function">getCurrentUserId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>map
                        <span class="token punctuation">(</span><span class="token class-name">RoleSmallDTO</span><span class="token operator">::</span><span class="token function">getLevel</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">IntegeroptLevel</span><span class="token operator">=</span>
<span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>roleService<span class="token punctuation">.</span><span class="token function">findRoleByUserId</span><span class="token punctuation">(</span>userId<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token class-name">RoleSmallDTO</span><span class="token operator">::</span><span class="token function">getLevel</span><span class="token punctuation">)</span><span class="token punctuation">.</span>collect
                        <span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//level 越小权限越大</span>
returncurrentLevel<span class="token operator">&lt;=</span>optLevel<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br></div></div><h2 id="系统缓存"><a href="#系统缓存" class="header-anchor">#</a> <strong>系统缓存</strong></h2> <p>本系统缓存运用springboot切面编程的思想与java反射原理开发了新的注解<code>@Query</code>与<code>@Queries</code>，通过新注解<code>@Query</code>与<code>@Queries</code>实现了原先<code>@One</code>和<code>@Many</code>的效果，</p> <h4 id="单一实体缓存-key和value都仅与该实体相关-1-1"><a href="#单一实体缓存-key和value都仅与该实体相关-1-1" class="header-anchor">#</a> 单一实体缓存，key和value都仅与该实体相关(1:1)</h4> <ul><li><p>首先是针对一个实体的单条信息进行缓存，key和value都和一个实体有关。如缓存job表的每一条记录，以id和键名，Job实体为value存入缓存：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>在<span class="token class-name">JobMapper</span>加上命名空间 <span class="token annotation punctuation">@CacheConfig</span><span class="token punctuation">(</span>cacheNames <span class="token operator">=</span> <span class="token string">&quot;job&quot;</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div></li> <li><p>首先在JobMapper加上命名空间：</p></li></ul> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@CacheConfig</span><span class="token punctuation">(</span>cacheNames <span class="token operator">=</span> <span class="token string">&quot;job&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">JobMapper</span> <span class="token keyword">extends</span> <span class="token class-name">BasicMapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Job</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><ul><li><p>虽然<code>BaseMapper</code>已经提供了根据id查询——<code>T selectById(Serializable id);</code></p> <p><strong>重写selectById，并加上@Cacheable</strong></p></li> <li><p>但是咱们需要加上缓存，所以需要重新在<code>mappe</code>r层写该方法（无需写sql），并加上<code>@Cacheable</code>，此时键名key的命名规则为统一的 <code>&quot;'id:' + #p0&quot;</code> ，id指Job的id，#p0指方法的第一个参数：</p></li></ul> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Cacheable</span><span class="token punctuation">(</span>key <span class="token operator">=</span> <span class="token string">&quot;'id:' + #p0&quot;</span><span class="token punctuation">)</span>
<span class="token class-name">Job</span> <span class="token function">selectById</span><span class="token punctuation">(</span><span class="token class-name">Long</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><ul><li><p>此时<code>springboot</code>会将第一查询的结果放入缓存，之后无论是从<code>service</code>调<code>mapper</code>的该方法，还是从<code>mapper</code>的<code>@Query</code>中调用该方法都可以走缓存。</p></li> <li><p>缓存情况如下图：</p> <img src="/smpe-admin-doc/img/image27.png" alt="foo"> <p><strong>将键名除id外以静态变量存入CacheKey</strong></p></li> <li><p>可以看到我们成功把id为1的job存入了<code>redis</code>缓存，该缓存的value即为Job实体类，键名为 job:🆔1 ，其中为了后期维护缓存方便，我们将字符串 &quot;job:🆔&quot; 作为静态变量存入<code>CacheKey.class</code>中，在做维护时只需拼接一个id即可：</p></li></ul> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">CacheKey</span> <span class="token punctuation">{</span>
    <span class="token comment">/**
     * 用户
     */</span>
    <span class="token class-name">String</span> USER_ID <span class="token operator">=</span> <span class="token string">&quot;user::id:&quot;</span><span class="token punctuation">;</span>
    <span class="token comment">/**
     * 数据
     */</span>
    <span class="token class-name">String</span> DATA_USER <span class="token operator">=</span> <span class="token string">&quot;data::user:&quot;</span><span class="token punctuation">;</span>
    <span class="token comment">/**
     * 菜单
     */</span>
    <span class="token class-name">String</span> MENU_ID <span class="token operator">=</span> <span class="token string">&quot;menu::id:&quot;</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> MENU_USER <span class="token operator">=</span> <span class="token string">&quot;menu::user:&quot;</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> MENU_ROLE <span class="token operator">=</span> <span class="token string">&quot;menu::role:&quot;</span><span class="token punctuation">;</span>
    <span class="token comment">/**
     * 角色授权
     */</span>
    <span class="token class-name">String</span> ROLE_AUTH <span class="token operator">=</span> <span class="token string">&quot;role::auth:&quot;</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> ROLE_USER <span class="token operator">=</span> <span class="token string">&quot;role::user:&quot;</span><span class="token punctuation">;</span>
    <span class="token comment">/**
     * 角色信息
     */</span>
    <span class="token class-name">String</span> ROLE_ID <span class="token operator">=</span> <span class="token string">&quot;role::id:&quot;</span><span class="token punctuation">;</span>
    <span class="token comment">/**
     * 部门信息
     */</span>
    <span class="token class-name">String</span> DEPT_ID <span class="token operator">=</span> <span class="token string">&quot;dept::id:&quot;</span><span class="token punctuation">;</span>
    <span class="token class-name">String</span> DEPT_ROLE <span class="token operator">=</span> <span class="token string">&quot;dept::role:&quot;</span><span class="token punctuation">;</span>
    <span class="token comment">/**
     * 岗位信息
     */</span>
    <span class="token class-name">String</span> JOB_ID <span class="token operator">=</span> <span class="token string">&quot;job::id:&quot;</span><span class="token punctuation">;</span>      <span class="token comment">//示例</span>
    <span class="token class-name">String</span> JOB_USER <span class="token operator">=</span> <span class="token string">&quot;job::user:&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br></div></div><p>在对应的<code>service</code>层手动维护缓存</p> <ul><li>这里为了统一建议手动维护缓存，即在<code>JobServiceImpl</code>下手写一个方法来清理缓存，在相应的更新、删除Job的地方调用该方法即可：</li></ul> <div class="language-java line-numbers-mode"><pre class="language-java"><code>    <span class="token comment">/**
     * 清理缓存
     * @param id job_id
     */</span>
<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">delCaches</span><span class="token punctuation">(</span><span class="token class-name">Long</span> id<span class="token punctuation">)</span><span class="token punctuation">{</span>
    redisUtils<span class="token punctuation">.</span><span class="token function">del</span><span class="token punctuation">(</span><span class="token class-name">CacheKey</span><span class="token punctuation">.</span>JOB_ID <span class="token operator">+</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><ul><li>你也可以在相应的更新、删除的方法上加上springboot删除缓存的注解（不推荐，后期缓存情况复杂）</li></ul> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@CacheEvict</span><span class="token punctuation">(</span>key <span class="token operator">=</span> <span class="token string">&quot;'id:' + #p0.id&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">update</span><span class="token punctuation">(</span><span class="token class-name">Job</span> resources<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p><strong>对于单一实体的缓存，仅缓存 selectById方法，对于该实体的分页查询等其他条件查询一般不做缓存，除非有特殊要求</strong></p> <h4 id="缓存内容关联两个及以上的实体-1-n-n-m"><a href="#缓存内容关联两个及以上的实体-1-n-n-m" class="header-anchor">#</a> 缓存内容关联两个及以上的实体（1:n,n:m）</h4> <ul><li><code>@Query</code>中所调用的方法必须要有缓存，这里user与job是多对多的关系，有一张中间sys_users_jobs，当我们在查询一个用户时要连带将其所有的岗位也查找出来：</li></ul> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">//UserMapper中查询一个用户</span>
<span class="token annotation punctuation">@Select</span><span class="token punctuation">(</span><span class="token string">&quot;SELECT id,dept_id,username,nick_name,gender,phone,email,avatar_path,password,&quot;</span> <span class="token operator">+</span>
            <span class="token string">&quot;is_admin,enabled,create_by,update_by,pwd_reset_time,create_time,update_time&quot;</span> <span class="token operator">+</span>
            <span class="token string">&quot; FROM sys_user u WHERE u.id = #{id} AND is_deleted=0&quot;</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@Results</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            <span class="token annotation punctuation">@Result</span><span class="token punctuation">(</span>column <span class="token operator">=</span> <span class="token string">&quot;id&quot;</span><span class="token punctuation">,</span> property <span class="token operator">=</span> <span class="token string">&quot;id&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token annotation punctuation">@Result</span><span class="token punctuation">(</span>column <span class="token operator">=</span> <span class="token string">&quot;dept_id&quot;</span><span class="token punctuation">,</span> property <span class="token operator">=</span> <span class="token string">&quot;deptId&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@Queries</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            <span class="token annotation punctuation">@Query</span><span class="token punctuation">(</span>column <span class="token operator">=</span> <span class="token string">&quot;id&quot;</span><span class="token punctuation">,</span> property <span class="token operator">=</span> <span class="token string">&quot;roles&quot;</span><span class="token punctuation">,</span>
                    select <span class="token operator">=</span> <span class="token string">&quot;marchsoft.modules.system.mapper.RoleMapper.findWithMenuByUserId&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token annotation punctuation">@Query</span><span class="token punctuation">(</span>column <span class="token operator">=</span> <span class="token string">&quot;id&quot;</span><span class="token punctuation">,</span> property <span class="token operator">=</span> <span class="token string">&quot;jobs&quot;</span><span class="token punctuation">,</span>
                    select <span class="token operator">=</span> <span class="token string">&quot;marchsoft.modules.system.mapper.JobMapper.findByUserId&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>  <span class="token comment">//这里</span>
            <span class="token annotation punctuation">@Query</span><span class="token punctuation">(</span>column <span class="token operator">=</span> <span class="token string">&quot;dept_id&quot;</span><span class="token punctuation">,</span> property <span class="token operator">=</span> <span class="token string">&quot;dept&quot;</span><span class="token punctuation">,</span>
                    select <span class="token operator">=</span> <span class="token string">&quot;marchsoft.modules.system.mapper.DeptMapper.selectById&quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@Cacheable</span><span class="token punctuation">(</span>key <span class="token operator">=</span> <span class="token string">&quot;'id:' + #p0&quot;</span><span class="token punctuation">)</span>
    <span class="token class-name">UserBO</span> <span class="token function">findUserDetailById</span><span class="token punctuation">(</span><span class="token class-name">Long</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><ul><li>既然通过<code>@Query</code>调用了<code>JobMapper.findByUserId</code>方法，我们就需要对其加缓存（其他的同理）</li></ul> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">//JobMapper中根据用户id查询岗位</span>
<span class="token annotation punctuation">@Select</span><span class="token punctuation">(</span><span class="token string">&quot;SELECT j.id, j.name, j.enabled, j.job_sort, j.create_by, j.update_by, j.create_time, j.update_time &quot;</span> <span class="token operator">+</span>
            <span class="token string">&quot;FROM sys_job j, sys_users_jobs uj WHERE j.id = uj.job_id AND uj.user_id = ${id} AND j.is_deleted=0&quot;</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Cacheable</span><span class="token punctuation">(</span>key <span class="token operator">=</span> <span class="token string">&quot;'user:' + #p0&quot;</span><span class="token punctuation">)</span>
<span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Job</span><span class="token punctuation">&gt;</span></span> <span class="token function">findByUserId</span><span class="token punctuation">(</span><span class="token class-name">Long</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><ul><li><p>此时缓存的命名规则为 key = &quot;'user:' + #p0&quot; ，这里的user指user_id的意思，后面的参数#p0就是user_id，我们可以发现此时的redis里缓存全称为： <code>job::user:2</code></p> <img src="/smpe-admin-doc/img/image29.jpg" alt="foo"></li> <li><p>意思即为user_id为2的用户所拥有的job，从value中可以看出该用户有两个job。我们也需要将 &quot;job::user:&quot; 存入 CacheKey中，命名为 JOB_USER （可以回看上面的）。</p> <p><strong>从每个与该缓存相关的实体的service层对其进行维护</strong></p></li> <li><p>以 job::user:2 缓存维护为例</p> <p><strong>Job发生删改时，可能需要对改缓存进行维护</strong></p></li> <li><p>当我们修改了一个id为1的job，可能id为2的user有这个job，也可能没有，有的话必须删除该缓存，即我们需要通过sys_users_jobs关系表找到含有job_id=2的user_id的集合，是一个List：</p></li></ul> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">//UserMapper下</span>
<span class="token comment">//根据job_id查询用户Id (清理job缓存时调用)</span>
<span class="token annotation punctuation">@Select</span><span class="token punctuation">(</span><span class="token string">&quot;SELECT user_id FROM sys_users_jobs WHERE job_id = #{id} group by user_id&quot;</span><span class="token punctuation">)</span>
<span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> <span class="token function">findByJobId</span><span class="token punctuation">(</span><span class="token class-name">Long</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><ul><li><p>注意，这里是因为job的变动导致需要清理该缓存，所以该部分清理缓存的代码写在 JobServiceImpl下的<code>delcache</code>方法中:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">//JobServiceImpl</span>
<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">delCaches</span><span class="token punctuation">(</span><span class="token class-name">Long</span> id<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> userIds <span class="token operator">=</span> userMapper<span class="token punctuation">.</span><span class="token function">findByJobId</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
    redisUtils<span class="token punctuation">.</span><span class="token function">delByKeys</span><span class="token punctuation">(</span><span class="token class-name">CacheKey</span><span class="token punctuation">.</span>JOB_USER<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">HashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>userIds<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//第二种情况所删的缓存</span>
    redisUtils<span class="token punctuation">.</span><span class="token function">del</span><span class="token punctuation">(</span><span class="token class-name">CacheKey</span><span class="token punctuation">.</span>JOB_ID <span class="token operator">+</span> id<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">//第一种情况所删的缓存</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>当中间表sys_users_jobs发生变动时，一定要清理缓存！</p> <ul><li><p>当我们修改了user的job时，如上图user_id = 2的用户有两个job，我们将其调整为一个job，此时也需要删除 job::user:2 这条缓存，由于是因为更新了user才导致删除这条缓存，所以该部分代码写在 <code>UserServiceImpl</code>的更新、删除中:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">//UserServiceImpl下的更新user方法</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">updateUserWithDetail</span><span class="token punctuation">(</span><span class="token class-name">UserInsertOrUpdateDTO</span> userInsertOrUpdateDTO<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token comment">//...</span>
<span class="token comment">//如果岗位发生变化</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span> <span class="token class-name">CollectionUtils</span><span class="token punctuation">.</span><span class="token function">isEqualCollection</span><span class="token punctuation">(</span>jobIds<span class="token punctuation">,</span> userInsertOrUpdateDTO<span class="token punctuation">.</span><span class="token function">getJobs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">//...</span>
      <span class="token comment">//清除缓存</span>
      redisUtils<span class="token punctuation">.</span><span class="token function">del</span><span class="token punctuation">(</span><span class="token class-name">CacheKey</span><span class="token punctuation">.</span>JOB_USER <span class="token operator">+</span> userInsertOrUpdateDTO<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">}</span>
<span class="token comment">//...</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><ul><li><p>这样，我们才算是对 job::user:2这条缓存做了完全的维护。</p> <p>对于情况一的缓存只涉及一个实体（表），缓存维护比较好实现，针对第二种情况需要我们考虑全面，在哪些地方需要去维护，这个需要考虑清除，不要随意加缓存</p></li></ul></li></ul></li></ul> <h2 id="异常处理"><a href="#异常处理" class="header-anchor">#</a> <strong>异常处理</strong></h2> <p>我们开发项目时，数据在请求过程中发生错误是避免不了的，我们需要捕获这些异常信息，做统一的异常处理。</p> <p>如：登陆失败，权限不足，数据为空，请求失败等。这些异常如果不经过处理，会对前端小伙伴造成非常大的困扰。</p> <p>做统一的异常返回，是项目中必不可少的一个模块。</p> <h3 id="自定义异常"><a href="#自定义异常" class="header-anchor">#</a> <strong>自定义异常</strong></h3> <p>通用异常</p> <p>封装了<code>BadRequestException</code>作为通用的异常处理</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Getter</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">BadRequestException</span> <span class="token keyword">extends</span> <span class="token class-name">RuntimeException</span> <span class="token punctuation">{</span>

<span class="token keyword">private</span> <span class="token class-name">Integer</span> status <span class="token operator">=</span> BAD_REQUEST<span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token class-name">BadRequestException</span><span class="token punctuation">(</span><span class="token class-name">String</span> msg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token keyword">super</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token class-name">BadRequestException</span><span class="token punctuation">(</span><span class="token class-name">Integer</span> status<span class="token punctuation">,</span> <span class="token class-name">String</span> msg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token keyword">super</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">=</span> status<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token keyword">public</span> <span class="token class-name">BadRequestException</span><span class="token punctuation">(</span><span class="token class-name">ResultEnum</span> resultEnum<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token keyword">super</span><span class="token punctuation">(</span>resultEnum<span class="token punctuation">.</span><span class="token function">getMsg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">=</span> resultEnum<span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><p>处理自定义异常(在全局异常处理中：<code>src/main/java/marchsoft/exception/handler/GlobalExceptionHandler.java</code>)</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">/**
* 功能描述：处理自定义异常
*
* @param e 自定义异常
* @return restful风格的异常信息
* @author RenShiWei
* Date: 2020/4/13 22:18
*/</span>
<span class="token annotation punctuation">@ExceptionHandler</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token class-name">BadRequestException</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">ResponseEntity</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Result</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">badRequestException</span><span class="token punctuation">(</span><span class="token class-name">BadRequestException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//默认到后端的请求，状态码都为200，自定义的异常由封装的code去控制</span>
<span class="token keyword">return</span> <span class="token class-name">ResponseEntity</span><span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token class-name">HttpStatus</span><span class="token punctuation">.</span>OK<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">body</span><span class="token punctuation">(</span><span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>其他异常的处理</p> <p>权限不足异常</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">/**
* description: security的角色权限不足异常
*
* @param e 权限不足异常
* @return 200状态码 403自定义code
* @author RenShiWei
* Date: 2020/8/7 19:52
*/</span>
<span class="token annotation punctuation">@ExceptionHandler</span><span class="token punctuation">(</span><span class="token class-name">AccessDeniedException</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">ResponseEntity</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Result</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">handleAccessDeniedException</span><span class="token punctuation">(</span><span class="token class-name">AccessDeniedException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">return</span> <span class="token class-name">ResponseEntity</span><span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token class-name">HttpStatus</span><span class="token punctuation">.</span>FORBIDDEN<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">body</span><span class="token punctuation">(</span><span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token class-name">ResultEnum</span><span class="token punctuation">.</span>IDENTITY_NOT_POW<span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token class-name">ResultEnum</span><span class="token punctuation">.</span>IDENTITY_NOT_POW<span class="token punctuation">.</span><span class="token function">getMsg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>不可知异常处理</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">/**
* 功能描述：处理所有不可知的异常
* @param e 异常 Throwable(异常的根类)
* @return 异常对象信息
* @author RenShiWei
* Date: 2020/7/10 10:54
*/</span>
<span class="token annotation punctuation">@ExceptionHandler</span><span class="token punctuation">(</span><span class="token class-name">Throwable</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">ResponseEntity</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Result</span><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> <span class="token function">handleException</span><span class="token punctuation">(</span><span class="token class-name">Throwable</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token comment">// 打印堆栈信息</span>
    log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">return</span> <span class="token class-name">ResponseEntity</span><span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token class-name">HttpStatus</span><span class="token punctuation">.</span>INTERNAL_SERVER_ERROR<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">body</span><span class="token punctuation">(</span><span class="token class-name">Result</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token class-name">ResultEnum</span><span class="token punctuation">.</span>SEVER_ERROR<span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">ResultEnum</span><span class="token punctuation">.</span>SEVER_ERROR<span class="token punctuation">.</span><span class="token function">getMsg</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>其他异常处理</p> <p>详情请见：<code>src/main/java/marchsoft/exception/handler/GlobalExceptionHandler.java</code></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// 通用异常</span>
<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BadRequestException</span><span class="token punctuation">(</span><span class="token string">&quot;发生了异常&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 通用异常，使用自定义状态码</span>
<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BadRequestException</span><span class="token punctuation">(</span><span class="token class-name">HttpStatus</span><span class="token punctuation">.</span>OK<span class="token punctuation">,</span> <span class="token string">&quot;发送了异常&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h2 id="数据权限"><a href="#数据权限" class="header-anchor">#</a> <strong>数据权限</strong></h2> <p>本系统是基于部门做的一个简单数据权限控制，也就是通过用户角色中的数据权限控制用户能看哪些数据。</p> <h3 id="注解方式"><a href="#注解方式" class="header-anchor">#</a> <strong>注解方式</strong></h3> <p>现可通过注解<code>@DataPermission</code> 进行权限控制</p> <h3 id="数据权限-2"><a href="#数据权限-2" class="header-anchor">#</a> <strong>数据权限</strong></h3> <p>系统提供了三种数据权限控制</p> <ul><li>全部数据权限：无数据权限限制</li> <li>本级数据权限：限制只能看到本部门数据</li> <li>自定义数据权限：可根据实际需要选择部门控制数据权限</li></ul> <img src="/smpe-admin-doc/img/image21.png" alt="foo"> <h2 id="定时任务"><a href="#定时任务" class="header-anchor">#</a> <strong>定时任务</strong></h2> <p>框架对定时任务做了整合</p> <p>对于简单的定时任务可以只使用spring 的<code>@sechduled</code> 注解</p> <p>对于动态管理动态任务，涉及到定时任务的增删改，以及数据库持久化储存，本框架整合了quartz，可通过后台管理页面对定时任务进行增删改查操作，</p> <p>并对定时任务进行了日志监控</p> <p>本模块的源码在 <code>smpe-system\src\main\java\marchsoft\modules\quartz</code></p> <p>后台页面展示：</p> <img src="/smpe-admin-doc/img/image22.png" alt="foo"> <h3 id="具体使用步骤"><a href="#具体使用步骤" class="header-anchor">#</a> 具体使用步骤：</h3> <ol><li>新增定时任务</li></ol> <p>打开定时任务调度界面，点击新增，填写具体参数</p> <img src="/smpe-admin-doc/img/image23.png" alt="foo"> <p><strong>参数解释</strong></p> <ul><li>任务名称：当前任务的名称，可以自定义</li> <li>任务描述：对该任务的描述</li> <li><code>bean</code>名称： 定时任务通过<code>bean</code>名称来获取具体执行的<code>bean</code>对象。需要执行的定时任务类，必须注入<code>spring</code>容器中。</li> <li>执行方法：  需要执行的方法名称，底层是通过反射执行方法。</li> <li><code>cron</code>表达式：定时任务通过<code>cron</code>表达式控制任务执行的时间，具体内容可以查询官方<code>cron</code>表达式介绍</li> <li>子任务<code>id</code>：子任务可以是当前已经定义过的任务的<code>id</code>，传入时需要用多个逗号隔开，当主任务执行后，子任务后按顺序依次执行。</li> <li>任务负责人：该任务的负责人</li> <li>告警邮箱：定时任务执行失败时会将失败信息通过邮箱发送给用户。如果有多个邮箱可以用逗号隔开，如果不需要则不用填。（该功能暂不支持）</li> <li>失败后暂停：选择定时任务失败后是否暂停当前定时任务。</li> <li>任务状态：选择是否开启当前定时任务。</li> <li>参数内容： 填写参数内容，可向后端传一个字符串参数，具体使用方法见下图</li></ul> <img src="/smpe-admin-doc/img/image24.png" alt="foo"> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TestTask</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run1</span><span class="token punctuation">(</span><span class="token class-name">String</span> str<span class="token punctuation">)</span><span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;run1 执行成功，参数为：&quot;</span> <span class="token operator">+</span> str<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><img src="/smpe-admin-doc/img/image26.png" alt="foo"> <p>前端可以根据该参数向后端传需要执行的内容。</p> <h3 id="原理解释"><a href="#原理解释" class="header-anchor">#</a> <strong>原理解释</strong></h3> <p>本框架使用的是<code>spring quartz</code>框架，详细解释可以参考博客<a href="https://blog.csdn.net/qq_45473439/article/details/113357101" target="_blank" rel="noopener noreferrer">'原理'<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>关于<code>quartz</code>框架的持久化操作，详情可以看本模块的源码 <code>smpe-system\src\main\java\marchsoft\modules\quartz</code></p> <h2 id="异步线程池"><a href="#异步线程池" class="header-anchor">#</a> <strong>异步线程池</strong></h2> <p>代码地址：<code>smpe-common\src\main\java\marchsoft\config\bean\AsyncTaskProperties.java</code></p> <p>源码如下：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">/**
 * description:异步任务线程池装配类
 *
 * @author RenShiWei
 * Date: 2020/7/12 21:58
 * '@EnableAsync' 开启异步线程，
 * 重写AsyncConfigurer的方法：使用@Async标注方法执行异步任务，每次都要添加注解，可以重写spring默认线程池的方式使用的时候，
 * 只需要加@Async注解就可以，不用去声明线程池类。
 */</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@Configuration</span>
<span class="token annotation punctuation">@EnableAsync</span>
<span class="token annotation punctuation">@RequiredArgsConstructor</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AsyncTaskExecutePool</span> <span class="token keyword">implements</span> <span class="token class-name">AsyncConfigurer</span> <span class="token punctuation">{</span>

<span class="token comment">/** 注入配置类 */</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">AsyncTaskProperties</span> config<span class="token punctuation">;</span>

<span class="token comment">/**
     * description: 设置线程池的参数配置
     *
     * @author RenShiWei
     * Date: 2020/8/11 15:44
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Executor</span> <span class="token function">getAsyncExecutor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">ThreadPoolTaskExecutor</span> executor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ThreadPoolTaskExecutor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 核心线程池大小</span>
        executor<span class="token punctuation">.</span><span class="token function">setCorePoolSize</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span><span class="token function">getCorePoolSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 最大线程数</span>
        executor<span class="token punctuation">.</span><span class="token function">setMaxPoolSize</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span><span class="token function">getMaxPoolSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 队列容量</span>
        executor<span class="token punctuation">.</span><span class="token function">setQueueCapacity</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span><span class="token function">getQueueCapacity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 活跃时间</span>
        executor<span class="token punctuation">.</span><span class="token function">setKeepAliveSeconds</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span><span class="token function">getKeepAliveSeconds</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 线程名字前缀</span>
        executor<span class="token punctuation">.</span><span class="token function">setThreadNamePrefix</span><span class="token punctuation">(</span><span class="token string">&quot;smpe-async-&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// setRejectedExecutionHandler：当pool已经达到max size的时候，如何处理新任务</span>
        <span class="token comment">// CallerRunsPolicy：不在新线程中执行任务，而是由调用者所在的线程来执行</span>
        executor<span class="token punctuation">.</span><span class="token function">setRejectedExecutionHandler</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ThreadPoolExecutor<span class="token punctuation">.</span>CallerRunsPolicy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        executor<span class="token punctuation">.</span><span class="token function">initialize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">return</span> executor<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token comment">/**
     * description: 异步任务的异常处理
     *
     * @author RenShiWei
     * Date: 2020/8/11 15:40
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">AsyncUncaughtExceptionHandler</span> <span class="token function">getAsyncUncaughtExceptionHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span>throwable<span class="token punctuation">,</span> method<span class="token punctuation">,</span> objects<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;====&quot;</span> <span class="token operator">+</span> throwable<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;====&quot;</span><span class="token punctuation">,</span> throwable<span class="token punctuation">)</span><span class="token punctuation">;</span>
            log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;exception method:&quot;</span> <span class="token operator">+</span> method<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br></div></div><p>使用方式如下</p> <p>使用<code>@EnableAsync</code>来开启异步的支持，使用<code>@Async</code>来对某个方法进行异步执行。</p> <h2 id="线程池工具"><a href="#线程池工具" class="header-anchor">#</a> <strong>线程池工具</strong></h2> <p>代码地址：<code>smpe-common\src\main\java\marchsoft\utils\ThreadPoolExecutorUtil.java</code></p> <p>源码如下：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">/**
 * description: 自定义线程池工具类
 *
 * @author RenShiWei
 * Date: 2020/7/12 21:58
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ThreadPoolExecutorUtil</span> <span class="token punctuation">{</span>

<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">ThreadPoolExecutor</span> <span class="token function">getPoll</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">AsyncTaskProperties</span> properties <span class="token operator">=</span> <span class="token class-name">SpringContextHolder</span><span class="token punctuation">.</span><span class="token function">getBean</span><span class="token punctuation">(</span><span class="token class-name">AsyncTaskProperties</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">ThreadPoolExecutor</span><span class="token punctuation">(</span>
                properties<span class="token punctuation">.</span><span class="token function">getCorePoolSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                properties<span class="token punctuation">.</span><span class="token function">getMaxPoolSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                properties<span class="token punctuation">.</span><span class="token function">getKeepAliveSeconds</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>SECONDS<span class="token punctuation">,</span>
<span class="token keyword">new</span> <span class="token class-name">ArrayBlockingQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>properties<span class="token punctuation">.</span><span class="token function">getQueueCapacity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token keyword">new</span> <span class="token class-name">TheadFactoryName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p>使用方式:</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>privatefinalstaticThreadPoolExecutor executor <span class="token operator">=</span><span class="token class-name">ThreadPoolExecutorUtil</span><span class="token punctuation">.</span><span class="token function">getPoll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h2 id="分页实现"><a href="#分页实现" class="header-anchor">#</a> <strong>分页实现</strong></h2> <p>自定义分页信息默认值，默认当前页是1，每页显示10条数据。</p> <p>代码地址：<code>smpe-common\src\main\java\marchsoft.base.PageVO</code></p> <p>​源码如下：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">/**
     * 获取排序信息，排序的字段和正反序
     */</span>
    <span class="token annotation punctuation">@ApiModelProperty</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;排序方式。(默认【创建时间倒序】:[{'column': 'create_time','asc': false}])。&quot;</span><span class="token punctuation">,</span>
            notes <span class="token operator">=</span> <span class="token string">&quot;例子：[{'column': 'create_time','asc': false},{'column':'name','asc': true}]&quot;</span>
    <span class="token punctuation">)</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> orders<span class="token punctuation">;</span>

    <span class="token comment">/**
     * 当前页默认值为1
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">Integer</span> <span class="token function">getCurrent</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> current <span class="token operator">=</span> <span class="token punctuation">(</span>current <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> current <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token number">1</span> <span class="token operator">:</span> current<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 每页大小默认为10
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">Integer</span> <span class="token function">getSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> size <span class="token operator">=</span> <span class="token punctuation">(</span>size <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> size <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token number">10</span> <span class="token operator">:</span> size<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * description:将orders（json数组字符串）转为List
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">OrderItem</span><span class="token punctuation">&gt;</span></span> <span class="token function">generateOrderList</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">OrderItem</span><span class="token punctuation">&gt;</span></span> orderItemList <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StrUtil</span><span class="token punctuation">.</span><span class="token function">isBlank</span><span class="token punctuation">(</span><span class="token function">getOrders</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            orderItemList<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token class-name">OrderItem</span><span class="token punctuation">.</span><span class="token function">desc</span><span class="token punctuation">(</span><span class="token string">&quot;create_time&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                orderItemList <span class="token operator">=</span> <span class="token class-name">JSONArray</span><span class="token punctuation">.</span><span class="token function">parseArray</span><span class="token punctuation">(</span>orders<span class="token punctuation">,</span> <span class="token class-name">OrderItem</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BadRequestException</span><span class="token punctuation">(</span><span class="token string">&quot;分页排序参数orders不合法，请传正确的参数格式——['column':'','asc':'true/false']&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> orderItemList<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * description:根据pageVO构建分页查询IPage
     */</span>
    <span class="token keyword">public</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">IPage</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">&gt;</span></span> <span class="token function">buildPage</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Page</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">K</span><span class="token punctuation">&gt;</span></span> page <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Page</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token function">getCurrent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">getSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        page<span class="token punctuation">.</span><span class="token function">addOrder</span><span class="token punctuation">(</span><span class="token function">generateOrderList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> page<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br></div></div><p>具体分页业务处理请参考项目 <code>smpe-common\src\main\java\marchsoft.utils.PageUtil</code></p> <h2 id="自定义后端代码生成"><a href="#自定义后端代码生成" class="header-anchor">#</a> <strong>自定义后端代码生成</strong></h2> <p>关于代码生成类MyBatis-Plus<strong>Generator</strong>的使用参考：<a href="https://blog.csdn.net/qq_42937522/article/details/110725251" target="_blank" rel="noopener noreferrer">自定义深度定制人性化的MyBatis-Plus的代码生成策略<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h2 id="自定义扩展mybatis-plus"><a href="#自定义扩展mybatis-plus" class="header-anchor">#</a> <strong>自定义扩展MyBatis-Plus</strong></h2> <p>参考：<a href="https://blog.csdn.net/qq_42937522/article/details/110740545" target="_blank" rel="noopener noreferrer">如何深度定制扩展MyBatis-Plus提供的Model、Mapper、Service层的方法<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/smpe-admin-doc/guide/frontHandbook.html" class="prev">
        前端手册
      </a></span> <span class="next"><a href="/smpe-admin-doc/guide/deployProject.html">
        部署项目
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/smpe-admin-doc/assets/js/app.f4ff953f.js" defer></script><script src="/smpe-admin-doc/assets/js/2.edc9681b.js" defer></script><script src="/smpe-admin-doc/assets/js/10.f5e8e399.js" defer></script>
  </body>
</html>
